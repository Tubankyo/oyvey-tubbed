package me.alpha432.oyvey.features.modules.combat;

import com.google.common.eventbus.Subscribe;
import me.alpha432.oyvey.OyVey;
import me.alpha432.oyvey.event.impl.PacketEvent;
import me.alpha432.oyvey.features.modules.Module;
import me.alpha432.oyvey.features.setting.Setting;
import net.minecraft.entity.Entity;
import net.minecraft.entity.LivingEntity;
import net.minecraft.entity.player.PlayerEntity;
import net.minecraft.item.AxeItem;
import net.minecraft.item.ItemStack;
import net.minecraft.network.packet.c2s.play.PlayerInteractEntityC2SPacket;
import org.lwjgl.glfw.GLFW;

public class ShieldBreaker extends Module {

    public ShieldBreaker() {
        super("ShieldBreaker", "Automatically breaks opponents' shields when key is pressed", Category.COMBAT, true, false, false);
    }

    // Keybind setting (default: B key)
    public final Setting<Integer> key = register(new Setting<>("Key", GLFW.GLFW_KEY_B));

    // Max distance to target enemies
    public final Setting<Double> range = register(new Setting<>("Range", 5.0, 1.0, 10.0));

    @Subscribe
    private void onPacketSend(PacketEvent.Send event) {
        // Only run if key is pressed
        if (!OyVey.keyManager.isKeyDown(key.getValue())) return;

        // Find nearest shielded player
        PlayerEntity target = findNearestShieldedPlayer();
        if (target == null) return;

        // Save current hotbar slot
        int oldSlot = mc.player.getInventory().selectedSlot;

        // Find an axe in hotbar
        int axeSlot = -1;
        for (int i = 0; i < 9; i++) {
            ItemStack stack = mc.player.getInventory().getStack(i);
            if (stack.getItem() instanceof AxeItem) {
                axeSlot = i;
                break;
            }
        }

        if (axeSlot == -1) return; // No axe found

        // Switch to axe
        mc.player.getInventory().selectedSlot = axeSlot;

        // Send attack packet to break shield
        mc.player.networkHandler.sendPacket(new PlayerInteractEntityC2SPacket(mc.player, target, PlayerInteractEntityC2SPacket.InteractType.ATTACK));

        // Switch back to original item
        mc.player.getInventory().selectedSlot = oldSlot;
    }

    private PlayerEntity findNearestShieldedPlayer() {
        PlayerEntity nearest = null;
        double nearestDistance = range.getValue();

        for (Entity entity : mc.world.getEntities()) {
            if (!(entity instanceof PlayerEntity player) || player == mc.player) continue;

            // Check if player has shield in main hand
            if (player.getMainHandStack().getItem().getName().getString().toLowerCase().contains("shield")) {
                double distance = mc.player.squaredDistanceTo(player);
                if (distance <= nearestDistance * nearestDistance) {
                    nearest = player;
                    nearestDistance = Math.sqrt(distance);
                }
            }
        }
        return nearest;
    }

    @Override
    public String getDisplayInfo() {
        return "Packet";
    }
}
